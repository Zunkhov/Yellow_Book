name: Deploy to EKS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: yellowbooks
  ECR_REGISTRY: 973614193125.dkr.ecr.us-east-1.amazonaws.com

permissions:
  id-token: write  
  contents: read

jobs:
  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-EKS-Deploy

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get latest image tags from ECR
        id: image-tags
        run: |
          # Get latest API image tag
          API_TAG=$(aws ecr describe-images \
            --repository-name yellowbooks-api \
            --region ${{ env.AWS_REGION }} \
            --query 'sort_by(imageDetails,& imagePushedAt)[-1].imageTags[0]' \
            --output text)
          
          # Get latest Web image tag
          WEB_TAG=$(aws ecr describe-images \
            --repository-name yellowbooks-web \
            --region ${{ env.AWS_REGION }} \
            --query 'sort_by(imageDetails,& imagePushedAt)[-1].imageTags[0]' \
            --output text)
          
          echo "api-tag=$API_TAG" >> $GITHUB_OUTPUT
          echo "web-tag=$WEB_TAG" >> $GITHUB_OUTPUT
          echo "API Image Tag: $API_TAG"
          echo "Web Image Tag: $WEB_TAG"

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name ${{ env.EKS_CLUSTER_NAME }} \
            --region ${{ env.AWS_REGION }}

      - name: Create namespace if not exists
        run: |
          kubectl create namespace yellowbooks --dry-run=client -o yaml | kubectl apply -f -

      - name: Create secrets
        run: |
          # Create database secret
          kubectl create secret generic yellowbooks-secrets \
            --from-literal=DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            --from-literal=JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            --from-literal=REVALIDATION_SECRET="${{ secrets.REVALIDATION_SECRET }}" \
            --namespace=yellowbooks \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply ConfigMap
        run: |
          kubectl apply -f k8s/base/configmap.yaml

      - name: Run database migration job
        run: |
          # Delete old migration job if exists
          kubectl delete job prisma-migration -n yellowbooks --ignore-not-found=true
          
          # Apply migration job
          kubectl apply -f k8s/base/migration-job.yaml
          
          # Wait for migration to complete
          kubectl wait --for=condition=complete --timeout=300s job/prisma-migration -n yellowbooks || \
          kubectl logs job/prisma-migration -n yellowbooks

      - name: Deploy API
        run: |
          kubectl apply -f k8s/base/api-deployment.yaml
          kubectl apply -f k8s/base/api-service.yaml

      # Web deployment skipped - using Vercel for frontend

      - name: Apply HPA
        run: |
          kubectl apply -f k8s/base/hpa.yaml

      - name: Apply Ingress
        run: |
          kubectl apply -f k8s/base/ingress.yaml

      - name: Wait for deployments
        run: |
          kubectl rollout status deployment/yb-api -n yellowbooks --timeout=5m

      - name: Get deployment status
        run: |
          echo "=== Pods ==="
          kubectl get pods -n yellowbooks
          
          echo "=== Services ==="
          kubectl get svc -n yellowbooks
          
          echo "=== Ingress ==="
          kubectl get ingress -n yellowbooks
          
          echo "=== ALB URL ==="
          kubectl get ingress yellowbooks-ingress -n yellowbooks -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'

      - name: Get ALB URL
        id: alb-url
        run: |
          # Wait for ALB to be provisioned
          sleep 30
          ALB_URL=$(kubectl get ingress yellowbooks-ingress -n yellowbooks -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          echo "alb-url=$ALB_URL" >> $GITHUB_OUTPUT
          echo "ðŸš€ Application deployed to: https://$ALB_URL"
