# .github/workflows/deploy-eks.yml
name: Deploy to AWS EKS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: eu-north-1
  EKS_CLUSTER_NAME: yellowbooks-cluster
  ECR_API_REPO: yellowbooks-api
  ECR_WEB_REPO: yellowbooks-web

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîê Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActionsEKSRole
          aws-region: ${{ env.AWS_REGION }}
      
      - name: üîë Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: üèóÔ∏è Build and push API image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd adoptable
          docker build -f apps/yb-api/Dockerfile \
            -t $ECR_REGISTRY/$ECR_API_REPO:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_API_REPO:latest \
            .
          docker push $ECR_REGISTRY/$ECR_API_REPO:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_API_REPO:latest
      
      - name: üåê Build and push Web image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd adoptable
          docker build -f apps/adoptable/Dockerfile \
            -t $ECR_REGISTRY/$ECR_WEB_REPO:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_WEB_REPO:latest \
            .
          docker push $ECR_REGISTRY/$ECR_WEB_REPO:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_WEB_REPO:latest
      
      - name: ‚öôÔ∏è Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name ${{ env.EKS_CLUSTER_NAME }} \
            --region ${{ env.AWS_REGION }}
      
      - name: üîí Create/Update Kubernetes Secrets
        run: |
          kubectl create secret generic yellowbooks-secrets \
            --from-literal=DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            --from-literal=JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            --from-literal=REVALIDATION_SECRET="${{ secrets.REVALIDATION_SECRET }}" \
            --namespace=yellowbooks \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: üì¶ Update manifests with ECR registry and image tags
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd adoptable
          # Update image references
          sed -i "s|<AWS_ACCOUNT_ID>|${{ secrets.AWS_ACCOUNT_ID }}|g" k8s/base/*.yaml
          sed -i "s|:latest|:${IMAGE_TAG}|g" k8s/base/*deployment.yaml k8s/base/migration-job.yaml
          
          # Update certificate ARN in ingress
          sed -i "s|ACCOUNT_ID|${{ secrets.AWS_ACCOUNT_ID }}|g" k8s/base/ingress.yaml
          sed -i "s|CERT_ID|${{ secrets.ACM_CERTIFICATE_ID }}|g" k8s/base/ingress.yaml
      
      - name: üóÑÔ∏è Run Database Migration
        run: |
          kubectl delete job prisma-migration -n yellowbooks --ignore-not-found
          kubectl apply -f k8s/base/migration-job.yaml
          kubectl wait --for=condition=complete --timeout=300s job/prisma-migration -n yellowbooks || true
      
      - name: üöÄ Deploy to Kubernetes
        run: |
          cd adoptable
          kubectl apply -f k8s/base/namespace.yaml
          kubectl apply -f k8s/base/configmap.yaml
          kubectl apply -f k8s/base/api-deployment.yaml
          kubectl apply -f k8s/base/api-service.yaml
          kubectl apply -f k8s/base/web-deployment.yaml
          kubectl apply -f k8s/base/web-service.yaml
          kubectl apply -f k8s/base/ingress.yaml
          kubectl apply -f k8s/base/hpa.yaml
      
      - name: ‚è≥ Wait for rollout
        run: |
          kubectl rollout status deployment/yb-api -n yellowbooks --timeout=5m
          kubectl rollout status deployment/yb-web -n yellowbooks --timeout=5m
      
      - name: ‚úÖ Verify deployment
        run: |
          kubectl get pods -n yellowbooks
          kubectl get svc -n yellowbooks
          kubectl get ingress -n yellowbooks